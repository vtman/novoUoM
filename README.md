# novoUoM

<h1>Codes for the NOVO project (proton therapy)</h1>

<nav>
  <ul>
    <li><a href="#link_coin">Finding coincident events</a></li>
    <li><a href="#link_coin_extract">extractTimeStamps: extract time stamps from ROOT files</a></li>
    <li><a href="#link_coin_radix">treeRadixSort: sort the binary data accoring to the time stamps</a></li>	  
    <li><a href="#link_coin_merge">mergeSort: merging data from all trees</a></li>
    <li><a href="#link_coin_coin">coinBinarySingle: searching for coincident events</a></li>
    <li><a href="#link_coin_bin2root">coinRoot: forming an output ROOT file</a></li>
    <li><a href="#link_coin_bin2txt">timeStampBin2Txt: display time stamp information</a></li>
    <li><a href="#link_tools">Tools</a></li>
  </ul>
  </nav>

<h2 id="link_coin">Finding coincident events</h2>

The experimental setup contains a set of scintillation bars. Detector elements are positioned at the ends of these bars and record the signal's waveforms generated by scintillations within the bars. Digitiser boards are connected to detector elements and can acquire data. There are several channels for each board (for the current boards we may have up to 16 channels). By default, signals from the opposite ends of scintillation bars are in pairs (neighbouring odd/even indices of the channels). The index of the channels start from 0. Channels 14 and 15 are not in use.

The system records data as ROOT files (see <a href="https://root.cern/">CERN website</a>). Each ROOT file contains a set of trees corresponding to digitiser boards. There may be other trees in the file; however, we store all data in trees named <b>dta</b>, <b>dtb</b>, etc. Each tree contains columns of data called branches. All branches within one tree have the same number of elements (entries).

Note that a digitiser board writes data in chunks. We cannot guarantee that the events are in order within a chunk. However, consequent chunks are in order, i.e. an event within a chunk <tt>I</tt> is always before any event from chunk <tt>I+1</tt>. The size of the chunk varies, but it is possible to estimate its maximum size.

The goal is to identify those scintillation events that may be responsible for multiple scintillation events within different scintillation bars. Therefore, we first need to find scintillation events occurring within a short time frame within one bar, i.e. timestamps corresponding to a pair of odd/even channels (of the same bar) are close to each other (short-time). Then, among all possible pairs of such events, we find pairs of events that are within a large time frame (long-time). We ignore all other scintillation events.

The goal is to have an input ROOT file, perform various processing and get an output ROOT file containing all the data as the original input file but only for coincident events.



<h3 id="link_coin_extract">extractTimeStamps: extract time stamps from ROOT files</h3>

We consider all trees in an input ROOT file that have three-symbol names and start with <b>dt</b>. We ignore all other trees. For each tree, we create a binary output file containing information about the time stamps. We assume that there are at least three branches in each tree and there are branches named <tt>channel</tt> (1 byte), <tt>timestamp</tt> (4 bytes) and <tt>timestampExtended</tt> (2 bytes). For each scintilaltion event we form a 18-byte block of data: 4 bytes of <tt>timestamp</tt>, 2 bytes of <tt>timestampExtended</tt>, 2 bytes of zeros, 8 bytes of the entry's index, 1 byte of <tt>channel</tt>, 1 byte of the gigitiser board's index). While we have only <tt>32 + 16</tt> bits for the time stamp, we pad the number to form the <tt>64</tt>-bit number.

<h4>Parameters</h4>

<ol>
  <li>Input ROOT file (string)</li>
  <li>Output folder (string)</li>
  <li>Prefix (string)</li>
</ol>

<tt>extractTimeStamps.exe D:\NOVO\conData\in\det_000206.root D:\NOVO\conData\out test</tt>



<h3 id="link_coin_radix">treeRadixSort: sort the binary data accoring to the time stamps</h3>

We consider the binary files formed in the previous step. Time stamps are the first 64 bits for each 16-byte block of data. We use the simplest version of the radix sort algorithm. Starting from the least-significant bit, we form two blocks of data corresponding to <tt>0</tt> and <tt>1</tt> values for the chosen bit, then concatenate these two blocks and consider the next bit. To speed up the processing, we find the smallest time stamp and subtract it from all entries we are given, then perform the radix sort and add up the original time stamp. In this way, we have to consider fewer bits.

The code uses multiple threads. We split the original records into large chunks of rows, sorted them, and saved the results to the final file. Since the size of blocks used by the digitiser board to write data to ROOT files is unknown, it is possible that the time stamps for large blocks in the current code are not for neighbouring blocks. Therefore, we need to perform another radix sorting near the interfaces of these blocks. 

<h4>Parameters</h4>

<ol>
  <li>Input ROOT file (string)</li>
  <li>Output folder (string)</li>
  <li>Prefix (string)</li>
</ol>

<tt>treeRadixSort.exe D:\NOVO\conData\in\det_000206.root D:\NOVO\conData\out test</tt>


<h3 id="link_coin_merge">mergeSort: merging data from all trees</h3>

We have several binary files sorted by time stamp values. We should merge them into one file and keep the time stamps sorted. For this purpose, we find the maximum value of the time stamp for all files. Then we want to split all data into smaller chunks to be processed by one thread independently. So, if there are <tt>N</tt> files, then all <tt>N</tt> chunks considered by a one thread should have the same range of values for time stamps. Therefore, we first process each file and find the start positions of these blocks. Then each thread can safely process the data as there is no chance that there are any other rows of data for the chosen range of time stamps outside these <tt>N</tt> blocks. Each thread uses the standard merge sort algorithm.

<h4>Parameters</h4>

<ol>
  <li>Input ROOT file (string)</li>
  <li>Output folder (string)</li>
  <li>Prefix (string)</li>
</ol>

<tt>mergeSort.exe D:\NOVO\conData\in\det_000206.root D:\NOVO\conData\out test</tt>


<h3 id="link_coin_coin">coinBinarySingle: searching for coincident events</h3>

Processing the merged binary file to get another binary file for coincident events. Controlled by two time parameters. The first parameter determines that an event is recorded on the same bar by two channels. The second parameter specifies the time frame for events taking place in different bars. Single-threaded code. The output is also a binary file.

<h4>Parameters</h4>

<ol>
  <li>Input binary file (string)</li>
  <li>Output binary file (string)</li>
  <li>timeStamp for the same bar (integer, positive)</li>
  <li>timeStamp for the different bars (integer, positive)</li>
</ol>

<tt>coinBinarySingle.exe D:\NOVO\conData\out\test_merged.bin D:\NOVO\conData\out\test_cbs.bin 2 200</tt>




<h3 id="link_coin_bin2root">coinRoot: forming an output ROOT file</h3>

We use the given binary file (for coincident events) to extract data from the original ROOT file and form a new ROOT file.

<h4>Parameters</h4>

<ol>
  <li>Input ROOT file (string)</li>
  <li>Binary file-manager (string)</li>
  <li>Output ROOT file (string)</li>
</ol>

<tt>coinRoot.exe D:\NOVO\conData\in\det_000206.root D:\NOVO\conData\out\test_cbs.bin D:\NOVO\conData\out\ts_000206_out.root</tt>



<h3 id="link_coin_bin2txt">timeStampBin2Txt: display time stamp information</h3>

Read an input binary file and write down the information as a text file.

<h4>Parameters</h4>

<ol>
  <li>Input binary file (string)</li>
  <li>Output text file (string)</li>
  <li>The first entry (start with 0, int)</li>
  <li>The number of entries (if < 0, then all remaining, int)</li>
</ol>

<tt>timeStampBin2Txt.exe D:\NOVO\conData\out\test_merged.bin D:\NOVO\conData\out\test_merged.txt 123456 1000</tt>







